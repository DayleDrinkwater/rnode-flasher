<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <title>RNode Flasher</title>

    <script src="./rnode.js"></script>
    <script src="./nrf52_dfu_flasher.js"></script>
    <script src="./zip.min.js"></script>

    <!-- tailwind css -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

    <!-- vue js -->
    <script src="https://unpkg.com/vue@3"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/core.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/md5.js"></script>

</head>
<body>

<div id="app" class="space-y-2">

    <div>
        <div>1. Put device into DFU Mode</div>
        <button @click="enterDfuMode" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
            Enter DFU Mode
        </button>
    </div>

    <div>

        <div>2. Select firmware.zip to flash</div>
        <div class="mb-1">
            <input ref="file" type="file"/>
        </div>

        <div v-if="!isFlashing">
            <button @click="flash" :disabled="isFlashing" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                Flash Now
            </button>
        </div>

        <div v-else>
            <span v-if="flashingProgress > 0">Flashing: {{flashingProgress}}%</span>
            <span v-else>Flashing: please wait...</span>
            <div class="mt-1 w-[200px] overflow-hidden rounded-full bg-gray-200">
                <div class="h-2 rounded-full bg-blue-600" :style="{ 'width': `${flashingProgress}%`}"></div>
            </div>
        </div>

    </div>

    <div>
        <div>3. After flashing, Detect RNode version</div>
        <button @click="detect" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
            Detect
        </button>
    </div>

</div>

<script>
    Vue.createApp({
        data() {
            return {
                isFlashing: false,
                flashingProgress: 0,
            };
        },
        mounted() {

        },
        methods: {
            async askForSerialPort() {

                if(!navigator.serial){
                    alert("Web Serial is not supported in this browser");
                    return null;
                }

                // ask user to select device
                return await navigator.serial.requestPort({
                    filters: [],
                });

            },
            async enterDfuMode() {

                // ask for serial port
                const serialPort = await this.askForSerialPort();
                if(!serialPort){
                    return;
                }

                // enter dfu mode
                const flasher = new Nrf52DfuFlasher(serialPort);
                await flasher.enterDfuMode();

            },
            async flash() {

                // ensure firmware file selected
                const file = this.$refs["file"].files[0];
                if(!file){
                    alert("Select a firmware file first");
                    return;
                }

                // ask for serial port
                const serialPort = await this.askForSerialPort();
                if(!serialPort){
                    return;
                }

                // update progress
                this.isFlashing = true;
                this.flashingProgress = 0;

                try {

                    // flash file
                    const flasher = new Nrf52DfuFlasher(serialPort);
                    await flasher.flash(file, (percentage, message) => {
                        this.flashingProgress = percentage;
                    });

                    // flashing successful
                    alert("Firmware has been flashed!");

                } catch(e) {
                    alert("Firmware flashing failed: " + e);
                    console.log(e);
                } finally {
                    this.isFlashing = false;
                }

            },
            async detect() {

                // ask for serial port
                const serialPort = await this.askForSerialPort();
                if(!serialPort){
                    return;
                }

                // check if device is an rnode
                const rnode = await RNode.fromSerialPort(serialPort);
                const isRNode = await rnode.detect();
                if(!isRNode){
                    alert("Selected device is not an RNode!");
                    return;
                }

                const firmwareVersion = await rnode.getFirmwareVersion();
                alert("RNode has firmware v" + firmwareVersion);

                console.log({
                    firmware_version: await rnode.getFirmwareVersion(),
                    platform: await rnode.getPlatform(),
                    mcu: await rnode.getMcu(),
                    board: await rnode.getBoard(),
                    device_hash: await rnode.getDeviceHash(),
                    firmware_hash_target: await rnode.getTargetFirmwareHash(),
                    firmware_hash: await rnode.getFirmwareHash(),
                    // rom: await rnode.getRom(),
                    frequency: await rnode.getFrequency(),
                    bandwidth: await rnode.getBandwidth(),
                    tx_power: await rnode.getTxPower(),
                    spreading_factor: await rnode.getSpreadingFactor(),
                    coding_rate: await rnode.getCodingRate(),
                    radio_state: await rnode.getRadioState(),
                    rx_stat: await rnode.getRxStat(),
                    tx_stat: await rnode.getTxStat(),
                    rssi_stat: await rnode.getRssiStat(),
                });

                await rnode.close();

            },
        },
    }).mount('#app');
</script>

</body>
</html>